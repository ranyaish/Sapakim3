<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>אפליקציית חישוב משכורות</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#d7f7f3; --bg2:#c7f1ee;      /* טורקיז בהיר */
      --card:#ffffff; --ink:#0b1c33; --muted:#6a7a95; --line:#e1e6ef;
      --acc:#6fb6ff; --acc2:#a7d4ff;     /* פסטל לכפתורים */
      --ok:#12d27c; --warn:#ffb020;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:Heebo,system-ui,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    header{padding:16px 18px;border-bottom:1px solid var(--line);background:#f6ffff;position:sticky;top:0;z-index:50}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .pad{padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .inp{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--ink)}
    .btn{background:var(--acc);color:#003;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:var(--acc2)}
    .btn.danger{background:#ffb1b1;color:#4b0000}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    label{font-size:14px;color:var(--muted)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .foot{margin-top:8px;font-size:12px;color:var(--muted)}
    /* סיכום חודשי עם גלילה אופקית */
    .hscroll{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:880px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:right;font-size:14px;white-space:nowrap}
    thead th{position:sticky;top:64px;background:#f2f7ff;font-weight:800;z-index:2}
    tfoot td, tfoot th{font-weight:800;background:#f8fbff;position:sticky;bottom:0}
    /* מודל */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:10px}
    .modal.show{display:flex}
    .modal-dialog{max-width:1000px;width:100%}
    .modal-content{background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 12px 48px rgba(0,0,0,.15);max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
    /* ---- Sticky modal header + nav buttons ---- */
    .modal-header{
      position: sticky; top: 0; z-index: 20; background: #fff;
      border-bottom: 1px solid var(--line); padding: 12px;
      display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px;
    }
    .modal-title{margin:0;text-align:center}
    .modal-body{overflow:auto;-webkit-overflow-scrolling:touch;padding:12px}
    .btn-mini{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;height:34px;padding:0 8px;border:1px solid #cfe0ff;border-radius:10px;background:#f3f7ff;color:#244;font-weight:700;cursor:pointer
    }
    .btn-mini:active{transform:translateY(1px)}
    .emp-nav{justify-self:end;display:inline-flex;gap:6px}
    #empCloseBtn{justify-self:start}
    /* טאבס בכרטיס */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fbff;color:#244;cursor:pointer}
    .tab.active{background:#e7f1ff;border-color:#cfe0ff;font-weight:800}
    .panel{display:none}
    .panel.show{display:block}
    .section{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-bottom:12px;background:#fff}
    .muted{color:var(--muted)}
    @media (max-width:700px){
      thead th{top:56px}
      .row > *{flex:1 1 200px}
      .modal-dialog{max-width:95vw}
      .btn{padding:10px 12px}
      .btn-mini{min-width:30px;height:30px}
    }
  </style>
</head>
<body>
<header><h1>אפליקציית חישוב משכורות</h1></header>

<div class="wrap">
  <!-- קופסת כלים עליונה -->
  <div class="card pad">
    <div class="row">
      <div>
        <label>קובץ Excel/CSV במבנה הקבוע</label><br>
        <input id="file" type="file" accept=".xlsx,.xls,.csv" class="inp" />
      </div>
      <div>
        <label>טעינת סשן JSON</label><br>
        <input id="importJSONFile" type="file" accept=".json" class="inp" style="display:none" />
        <button id="importJSON" class="btn secondary">בחר קובץ</button>
      </div>
      <div>
        <label>בחירת עובד</label><br>
        <select id="employeeFilter" class="inp" disabled></select>
      </div>
      <div class="toolbar">
        <button id="openCardBtn" class="btn">פתח כרטיס עובד</button>
        <button id="exportDaily" class="btn" disabled>(XLSX) ייצוא יומי</button>
        <button id="exportSummary" class="btn" disabled>(XLSX) ייצוא חודשי</button>
        <button id="exportJSON" class="btn secondary" disabled>ייצוא JSON</button>
        <button id="clearSession" class="btn danger">נקה סשן</button>
      </div>
    </div>
    <div class="foot">שבת <b>08:00–17:00</b> = 150% (אם משמרת מתחילה בשבת מ-16:00 ומעלה – לא נספרות שעות שבת). מצב A: 9/11 → 100%/125%/150%; מצב B: ללא נוספות.</div>
  </div>

  <!-- סיכום חודשי -->
  <div class="card pad" style="margin-top:14px">
    <div class="toolbar"><span style="font-weight:800">סיכום חודשי</span><span class="muted">ניתן לגלול אופקית</span></div>
    <div class="hscroll">
      <table id="summaryTable">
        <thead>
          <tr>
            <th>עובד</th><th>סה"כ שעות</th><th>רגיל 100%</th><th>נוספות 125%</th><th>נוספות 150%</th><th>שבת 150%</th><th>שעות משוקללות</th><th>שכר בסיס</th><th>נסיעות</th><th>טיפים</th><th>תוספת שכר</th><th>החזר מקדמה</th><th>שכר ברוטו</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr id="summaryTotalsRow"><th>סה״כ</th><td colspan="12">—</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- מודל כרטיס עובד -->
<div id="empModal" class="modal" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Sticky header + ניווט -->
      <div class="modal-header">
        <button id="empCloseBtn" class="btn danger" onclick="closeEmpModal()">סגור</button>
        <h3 id="empModalTitle" class="modal-title">כרטיס עובד</h3>
        <div class="emp-nav">
          <button class="btn-mini" id="empPrevBtn" title="הקודם">‹</button>
          <button class="btn-mini" id="empNextBtn" title="הבא">›</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="tabs">
          <button id="tab-config"  class="tab active">פרטי שכר</button>
          <button id="tab-daily"   class="tab">פירוט יומי + סעיפי שכר</button>
          <button id="tab-punches" class="tab">משמרות (כניסה/יציאה)</button>
        </div>

        <!-- פרטי שכר -->
        <div id="panel-config" class="panel show">
          <div class="section">
            <div class="row">
              <div style="min-width:220px">
                <label>מצב חישוב</label><br>
                <select id="empMode" class="inp">
                  <option value="A">מצב A – נוספות יומיות (9/11)</option>
                  <option value="B">מצב B – ללא נוספות</option>
                </select>
              </div>
              <div style="min-width:180px">
                <label>שכר לשעה (₪)</label><br>
                <input id="empRate" type="number" min="0" step="0.01" class="inp" />
              </div>
            </div>
          </div>

          <div class="section">
            <div class="row">
              <div>
                <label>חודש (YYYY-MM)</label><br>
                <select id="empMonthSel" class="inp" style="min-width:160px"></select>
              </div>
              <div style="align-self:flex-end">
                <button id="recalcMonth" class="btn secondary">תצוגת חודש</button>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="row">
              <div style="min-width:160px">
                <label>שעות משוקללות</label><div id="empWgt" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>שכר בסיס</label><div id="empBase" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>סעיפי שכר</label><div id="empExtrasSum" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>שכר ברוטו</label><div id="empFinal" style="font-weight:800">0.00</div>
              </div>
            </div>
            <div class="muted" style="margin-top:6px">הסעיפים נשמרים לפי חודש עובד. השינויים מתעדכנים מידית בסיכום.</div>
          </div>
        </div>

        <!-- פירוט יומי + סעיפים -->
        <div id="panel-daily" class="panel">
          <div class="section">
            <div class="row">
              <div>
                <label>חודש (YYYY-MM)</label><br>
                <select id="empMonthSel2" class="inp" style="min-width:160px"></select>
              </div>
            </div>
          </div>

          <div class="section">
            <label style="font-weight:800">סעיפים חודשיים (נשמרים בסשן)</label>
            <div class="row">
              <div><label>נסיעות (₪)</label><br><input id="extra_travel"  type="number" step="0.01" class="inp" value="0"></div>
              <div><label>טיפים (₪)</label><br>   <input id="extra_tips"    type="number" step="0.01" class="inp" value="0"></div>
              <div><label>תוספת שכר (₪)</label><br><input id="extra_bonus"   type="number" step="0.01" class="inp" value="0"></div>
              <div><label>החזר מקדמה (₪-)</label><br><input id="extra_advance" type="number" step="0.01" class="inp" value="0"></div>
              <div style="align-self:flex-end"><button id="saveExtrasBtn" class="btn">שמירה</button></div>
            </div>
          </div>

          <div class="section hscroll">
            <table id="empCardDaily">
              <thead>
                <tr>
                  <th>תאריך</th><th>סה"כ</th><th>100%</th><th>125%</th><th>150%</th><th>שבת 150%</th><th>משוקלל</th><th>שכר יום</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="section">
            <div class="row">
              <div style="min-width:160px">
                <label>שעות משוקללות</label><div id="empWgt_d" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>שכר בסיס</label><div id="empBase_d" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>סעיפי שכר</label><div id="empExtrasSum_d" style="font-weight:800">0.00</div>
              </div>
              <div style="min-width:160px">
                <label>שכר ברוטו</label><div id="empFinal_d" style="font-weight:800">0.00</div>
              </div>
            </div>
          </div>
        </div>

        <!-- רשימת משמרות -->
        <div id="panel-punches" class="panel">
          <div class="section hscroll">
            <table id="empPunches">
              <thead>
                <tr><th>תאריך</th><th>יום</th><th>כניסה</th><th>יציאה</th><th>סה"כ</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ספריות -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>
<script src="app.js"></script>
<script>console.log('payroll app version','1.9.8-r2');</script>
</body>
</html>
