<!doctype html>
<html lang="he" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>סיכום תשלומי ספקים — payments v1.0 (קריאה בלבד)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --bg:#f6f8fb; --card:#fff; --border:#e5e7eb; --ink:#0f172a; --muted:#64748b; --accent:#111827; }
  * { box-sizing:border-box }
  body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial }
  header { position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--border);
           padding:12px 16px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  h1 { margin:0; font-size:20px; font-weight:800 }
  .muted { color:var(--muted) }
  .btn { border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px 14px; cursor:pointer; }
  .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.small { padding:6px 10px; font-size:14px }
  input,select { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff }
  .badge { padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff }
  .ok { color:#047857 } .err { color:#b91c1c }
  main { padding:16px; max-width:1100px; margin:auto }
  .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px }
  table { width:100%; border-collapse:separate; border-spacing:0 }
  th,td { text-align:right; padding:10px; border-top:1px solid var(--border) }
  thead th { background:#f3f4f6; border-top:none }
  .hidden { display:none }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .grow { flex:1 }
</style>

<header>
  <div class="row">
    <h1>סיכום תשלומי ספקים</h1>
    <span class="badge">payments v1.0</span>
    <span class="muted">קריאה בלבד</span>
  </div>
  <div class="row">
    <input id="email" placeholder="אימייל" autocomplete="username">
    <input id="password" placeholder="סיסמה" type="password" autocomplete="current-password">
    <button id="loginBtn" class="btn primary">כניסה</button>
    <button id="logoutBtn" class="btn hidden">יציאה</button>
    <span id="whoami" class="badge hidden"></span>
    <span id="authMsg" class="muted"></span>
  </div>
</header>

<main id="app" class="hidden">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <label class="muted" for="monthPicker">בחר חודש:</label>
        <input type="month" id="monthPicker" style="width:auto">
        <button id="refreshBtn" class="btn">רענן</button>
      </div>
      <div class="row">
        <button id="exportCsvBtn" class="btn small">ייצוא CSV</button>
        <span class="badge">סה״כ כל הספקים: <b id="grandTotal">₪0.00</b></span>
      </div>
    </div>

    <div style="margin-top:10px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table>
        <thead><tr><th>ספק</th><th>מס׳ חשבוניות</th><th>סה״כ לחודש</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const on=(el,ev,fn)=> el&&el.addEventListener(ev,fn,false);
  const fmt=n=> new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n)||0);

  // === CONFIG: אותם פרטים של הפרויקט שלך ===
  const SUPABASE_URL = 'https://uzaqpwbejceyuhnmfdmq.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6YXFwd2JlamNleXVobm1mZG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODc3NzMsImV4cCI6MjA3MDg2Mzc3M30.Wcuu97xzFvJCt8x2ubHLwc19-ZsfrRLK9YZHICV3T3A';

  let supabase=null, currentUser=null;
  let suppliers=[];     // [{id,name,...}]
  let monthInvoices=[]; // חשבוניות של החודש הנבחר

  // UI
  const app=$('#app'), authMsg=$('#authMsg'), whoami=$('#whoami'),
        emailEl=$('#email'), passEl=$('#password'),
        loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn');

  const monthPicker=$('#monthPicker'), refreshBtn=$('#refreshBtn'),
        tbody=$('#tbody'), grandTotalEl=$('#grandTotal'), exportBtn=$('#exportCsvBtn');

  function setAuthUI(on, email){
    if(on){
      app.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      whoami.classList.remove('hidden');
      whoami.textContent=email||'';
      emailEl.classList.add('hidden'); passEl.classList.add('hidden'); loginBtn.classList.add('hidden');
      authMsg.textContent='מחובר'; authMsg.className='ok';
    } else {
      app.classList.add('hidden');
      logoutBtn.classList.add('hidden');
      whoami.classList.add('hidden'); whoami.textContent='';
      emailEl.classList.remove('hidden'); passEl.classList.remove('hidden'); loginBtn.classList.remove('hidden');
      authMsg.textContent=''; authMsg.className='';
    }
  }

  // ===== DB helpers =====
  function monthStartEnd(ym){
    const [y,m] = (ym||'').split('-').map(Number);
    const now = new Date();
    const yy = y || now.getUTCFullYear();
    const mm = m || (now.getUTCMonth()+1);
    const start = new Date(Date.UTC(yy, mm-1, 1));
    const end   = new Date(Date.UTC(yy, mm, 1));
    const toISO = d => d.toISOString().slice(0,10);
    return { startISO: toISO(start), endISO: toISO(end) };
  }

  async function loadSuppliers(){
    const { data, error } = await supabase.from('suppliers').select('id,name').order('name',{ascending:true});
    if(error) throw error;
    return data||[];
  }

  async function loadInvoicesForMonth(isoStart, isoEnd){
    const { data, error } = await supabase
      .from('invoices')
      .select('id,supplier_id,date,amount')
      .gte('date', isoStart).lt('date', isoEnd);
    if(error) throw error;
    return data||[];
  }

  // ===== Render =====
  function renderTable(){
    // מיפוי לפי ספק
    const bySupplier = new Map();
    monthInvoices.forEach(inv=>{
      const sid = inv.supplier_id;
      const prev = bySupplier.get(sid) || { count:0, sum:0 };
      bySupplier.set(sid, { count: prev.count+1, sum: prev.sum + (Number(inv.amount)||0) });
    });

    // בניית שורות לכל הספקים — גם מי שאין לו בחודש זה
    tbody.innerHTML = '';
    let grand = 0;
    suppliers.forEach(s=>{
      const agg = bySupplier.get(s.id) || { count:0, sum:0 };
      grand += agg.sum;
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = s.name || '(ללא שם)';
      const tdCnt  = document.createElement('td'); tdCnt.textContent  = agg.count;
      const tdSum  = document.createElement('td'); tdSum.textContent  = fmt(agg.sum);
      tr.appendChild(tdName); tr.appendChild(tdCnt); tr.appendChild(tdSum);
      tbody.appendChild(tr);
    });
    grandTotalEl.textContent = fmt(grand);

    // שורת סיכום
    const trSum = document.createElement('tr');
    trSum.style.fontWeight='bold';
    const td1 = document.createElement('td'); td1.textContent='סה״כ';
    const td2 = document.createElement('td'); td2.textContent='';
    const td3 = document.createElement('td'); td3.textContent=fmt(grand);
    trSum.appendChild(td1); trSum.appendChild(td2); trSum.appendChild(td3);
    tbody.appendChild(trSum);
  }

  function exportCsv(){
    // טוענים מהטבלה המוצגת
    const rows = [['ספק','מס׳ חשבוניות','סה״כ לחודש']];
    [...tbody.querySelectorAll('tr')].forEach(tr=>{
      const tds=[...tr.children].map(td=> td.textContent.replace(/,/g,''));
      if (tds.length>=3) rows.push([tds[0], tds[1], tds[2]]);
    });
    const csv = rows.map(r=> r.map(field=>{
      const f = (field ?? '').toString().replace(/"/g,'""');
      return `"${f}"`;
    }).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ym = (monthPicker.value || new Date().toISOString().slice(0,7)).replace('-','');
    a.href = url;
    a.download = `suppliers_month_${ym}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== Flow =====
  async function refresh(){
    // קובע חודש ברירת מחדל
    if(!monthPicker.value) monthPicker.value = new Date().toISOString().slice(0,7);
    const { startISO, endISO } = monthStartEnd(monthPicker.value);
    suppliers = await loadSuppliers();
    monthInvoices = await loadInvoicesForMonth(startISO, endISO);
    renderTable();
  }

  // === Boot ===
  async function boot(){
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    // התחברות (הפלואו היציב — ללא trim לסיסמה)
    on(loginBtn, 'click', async (e)=>{
      e.preventDefault();
      authMsg.textContent='מתחבר...';
      const email=(emailEl.value||'').trim();
      const password=(passEl.value||''); // בלי trim
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ authMsg.textContent='שגיאה: '+error.message; authMsg.className='err'; }
      else {
        const { data:{ session } } = await supabase.auth.getSession();
        currentUser = session?.user||null;
        setAuthUI(!!currentUser, currentUser?.email);
        await refresh();
      }
    });

    on(logoutBtn, 'click', async ()=>{
      await supabase.auth.signOut();
      currentUser=null; setAuthUI(false);
    });

    on(refreshBtn, 'click', refresh);
    on(monthPicker, 'change', refresh);
    on(exportBtn, 'click', exportCsv);

    // אם כבר מחובר — טען
    const { data:{ session } } = await supabase.auth.getSession();
    if(session?.user){
      currentUser=session.user; setAuthUI(true, currentUser.email);
      await refresh();
    }
    supabase.auth.onAuthStateChange(async (_e, sess)=>{
      if(sess?.user){
        currentUser=sess.user; setAuthUI(true, currentUser.email); await refresh();
      } else {
        currentUser=null; setAuthUI(false);
      }
    });
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
</html>