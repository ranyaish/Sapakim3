<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>ניהול ספקים</title>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; }
    nav { margin-bottom: 20px; }
    .tab { display: none; }
    .active { display: block; }
    .err { color: red; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    #filterBar { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>ניהול ספקים</h2>

  <nav>
    <button id="suppliersTabBtn">ספקים</button>
    <button id="logoutBtn">יציאה</button>
  </nav>

  <!-- טאב ספקים -->
  <div id="suppliersTab" class="tab active">
    <h3>חשבוניות ספק</h3>

    <!-- בר בחירת חודש -->
    <div id="filterBar">
      <label for="monthFilter">בחר חודש:</label>
      <input type="month" id="monthFilter">
      <button id="clearFilterBtn">נקה סינון</button>
    </div>

    <table id="invoicesTable">
      <thead>
        <tr>
          <th>תאריך</th>
          <th>ספק</th>
          <th>סכום</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h4>סיכום חודשי: <span id="totalAmount">0</span> ₪</h4>
  </div>

  <div id="authMsg"></div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // === חיבור לסופאבייס ===
    const supabaseUrl = "https://uzaqpwbejceyuhnmfdmq.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // === אלמנטים ===
    const suppliersTabBtn = document.getElementById("suppliersTabBtn");
    const suppliersTab = document.getElementById("suppliersTab");
    const logoutBtn = document.getElementById("logoutBtn");
    const invoicesTableBody = document.querySelector("#invoicesTable tbody");
    const totalAmountEl = document.getElementById("totalAmount");
    const monthFilter = document.getElementById("monthFilter");
    const clearFilterBtn = document.getElementById("clearFilterBtn");

    let currentUser = null;
    let invoices = []; // נאחסן כאן את כל החשבוניות

    // === התחברות קיימת ===
    async function checkSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        currentUser = session.user;
        await refreshInvoices();
      } else {
        document.getElementById("authMsg").textContent = "אנא התחבר מחדש";
      }
    }

    // === יציאה ===
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      currentUser = null;
      location.reload();
    });

    // === טעינת חשבוניות מה-DB ===
    async function refreshInvoices() {
      const { data, error } = await supabase.from("invoices").select("*");
      if (error) {
        console.error("שגיאה בטעינת חשבוניות:", error.message);
        return;
      }
      invoices = data;
      renderInvoices();
    }

    // === הצגת חשבוניות ===
    function renderInvoices() {
      const selectedMonth = monthFilter.value; // yyyy-mm
      invoicesTableBody.innerHTML = "";
      let total = 0;

      invoices.forEach(inv => {
        const date = new Date(inv.date);
        const invMonth = date.toISOString().slice(0,7); // yyyy-mm

        if (!selectedMonth || invMonth === selectedMonth) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${inv.date}</td>
            <td>${inv.supplier}</td>
            <td>${inv.amount}</td>
          `;
          invoicesTableBody.appendChild(tr);
          total += inv.amount;
        }
      });

      totalAmountEl.textContent = total.toFixed(2);
    }

    // === אירוע סינון לפי חודש ===
    monthFilter.addEventListener("change", renderInvoices);
    clearFilterBtn.addEventListener("click", () => {
      monthFilter.value = "";
      renderInvoices();
    });

    // === הפעלה ראשונית ===
    checkSession();
  </script>
</body>
</html>
