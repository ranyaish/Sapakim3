<!doctype html>
<html lang="he" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ניהול ספקים — v1-stable</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root { --bg:#f6f8fb; --card:#fff; --border:#e5e7eb; --ink:#0f172a; --muted:#64748b; --accent:#111827; }
  * { box-sizing:border-box }
  body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial }
  header { position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--border);
           padding:12px 16px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  h1 { margin:0; font-size:20px; font-weight:800 }
  .muted { color:var(--muted) }
  .btn { border:1px solid var(--border); background:#fff; border-radius:12px; padding:6px 10px; cursor:pointer; font-size:14px }
  .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent) }
  input,select { border:1px solid var(--border); border-radius:12px; padding:8px; background:#fff }
  main { padding:16px; display:grid; grid-template-columns:1fr; gap:16px }
  @media(min-width:980px){ main { grid-template-columns:320px 1fr } }
  .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px }
  ul { list-style:none; margin:0; padding:0 }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .grow { flex:1 }
  .supplier-row { display:flex; align-items:center; justify-content:space-between; gap:8px;
                  border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff }
  .supplier-row.active { outline:2px solid #111827; outline-offset:2px; background:#eef2ff }
  .supplier-name { flex:1; text-align:right; background:transparent; border:none }
  table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
  th,td { text-align:right; padding:6px; border-top:1px solid var(--border) }
  thead th { background:#f3f4f6; border-top:none }
  .badge { padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff; font-size:13px }
  .ok { color:#047857 } .err { color:#b91c1c }
</style>

<header>
  <div class="row">
    <h1>ניהול ספקים</h1>
    <a href="payments.html" class="btn small">סיכום חודשי לספקים</a>
  </div>
  <div class="row">
    <input id="email" placeholder="אימייל" autocomplete="username">
    <input id="password" placeholder="סיסמה" type="password" autocomplete="current-password">
    <button id="loginBtn" class="btn primary">כניסה</button>
    <button id="logoutBtn" class="btn hidden">יציאה</button>
    <span id="whoami" class="badge hidden"></span>
    <span id="authMsg" class="muted"></span>
  </div>
</header>

<main id="app" class="hidden">
  <aside class="card" id="suppliersPane">
    <h3>ספקים</h3>
    <div class="row">
      <input id="supplierName" class="grow" placeholder="שם ספק">
      <button id="addSupplierBtn" class="btn primary">הוסף</button>
    </div>
    <ul id="supplierList" style="margin-top:10px;max-height:60vh;overflow:auto"></ul>
  </aside>

  <section class="card" id="ledgerPane">
    <div id="emptyState" class="muted">בחר ספק כדי להתחיל</div>
    <div id="ledger" class="hidden">
      <div class="row" style="justify-content:space-between">
        <h3 id="ledgerTitle">כרטסת</h3>
        <div class="badge">סה״כ לספק: <b id="grandTotal">₪0.00</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <input type="date" id="invDate">
        <input type="number" step="any" id="invAmount" placeholder="0">
        <input id="invNotes" class="grow" placeholder="הערות (אופציונלי)">
        <button id="addInvoiceBtn" class="btn primary">הוסף חשבונית</button>
      </div>
      <div style="margin-top:10px;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table>
          <thead>
            <tr><th>תאריך</th><th>סכום</th><th>הערות</th><th>שולם</th><th></th></tr>
          </thead>
          <tbody id="invoiceTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const fmt=n=> new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n)||0);

  const SUPABASE_URL='https://uzaqpwbejceyuhnmfdmq.supabase.co';
  const SUPABASE_ANON='eyJhbGciOiJIUzI1NiIs...'; // השאר כפי שהגדרת
  let supabase=null, currentUser=null;
  let suppliers=[], activeSupplierId=localStorage.getItem("activeSupplierId")||null;
  window.__allInvoices=[];

  async function loadSuppliers(){
    const {data}=await supabase.from('suppliers').select('*').order('created_at',{ascending:false});
    return data||[];
  }
  async function loadInvoicesAll(){
    const {data}=await supabase.from('invoices').select('*').order('date',{ascending:false});
    return data||[];
  }
  async function addInvoice(supplier_id,date,amount,notes){
    await supabase.from('invoices').insert({supplier_id,date,amount,notes});
  }
  async function deleteInvoice(id){
    await supabase.from('invoices').delete().eq('id',id);
  }
  async function togglePaid(id,paid){
    const paid_at = paid ? new Date().toISOString().slice(0,10) : null;
    await supabase.from('invoices').update({paid,paid_at}).eq('id',id);
  }

  const supplierList=$('#supplierList'), ledger=$('#ledger'), emptyState=$('#emptyState'),
        ledgerTitle=$('#ledgerTitle'), invoiceTableBody=$('#invoiceTableBody'), grandTotalEl=$('#grandTotal');

  function renderSuppliers(){
    supplierList.innerHTML='';
    suppliers.forEach(s=>{
      const li=document.createElement('li');
      const row=document.createElement('div'); row.className='supplier-row'+(activeSupplierId===s.id?' active':'');
      const btn=document.createElement('button'); btn.className='supplier-name'; btn.textContent=s.name;
      btn.onclick=()=>{ activeSupplierId=s.id; localStorage.setItem("activeSupplierId",s.id); renderAll(); };
      row.appendChild(btn); li.appendChild(row); supplierList.appendChild(li);
    });
  }

  function renderLedger(){
    if(!activeSupplierId){ emptyState.classList.remove('hidden'); ledger.classList.add('hidden'); return; }
    emptyState.classList.add('hidden'); ledger.classList.remove('hidden');
    const s=suppliers.find(x=>x.id===activeSupplierId);
    ledgerTitle.textContent='כרטסת: '+(s?.name||'');
    const arr=window.__allInvoices.filter(i=>i.supplier_id===activeSupplierId);
    const total=arr.reduce((t,i)=>t+((i.paid?0:Number(i.amount))||0),0);
    grandTotalEl.textContent=fmt(total);

    invoiceTableBody.innerHTML='';
    arr.forEach(i=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=new Date(i.date).toLocaleDateString('he-IL');
      const td2=document.createElement('td'); td2.textContent=fmt(i.amount);
      const td3=document.createElement('td'); td3.textContent=i.notes||'';
      const td4=document.createElement('td');
      const btnPaid=document.createElement('button');
      btnPaid.className='btn small'; btnPaid.textContent=i.paid?'✔ '+(i.paid_at||''):'שולם';
      btnPaid.onclick=async()=>{ await togglePaid(i.id,!i.paid); await refresh(); };
      td4.appendChild(btnPaid);
      const td5=document.createElement('td');
      const btnDel=document.createElement('button');
      btnDel.className='btn small'; btnDel.textContent='מחק';
      btnDel.onclick=async()=>{ if(confirm('מאשר מחיקה?')){ await deleteInvoice(i.id); await refresh(); } };
      td5.appendChild(btnDel);
      [td1,td2,td3,td4,td5].forEach(x=>tr.appendChild(x));
      invoiceTableBody.appendChild(tr);
    });
  }

  function renderAll(){ renderSuppliers(); renderLedger(); }

  async function refresh(){
    suppliers=await loadSuppliers();
    window.__allInvoices=await loadInvoicesAll();
    if(suppliers.length && !activeSupplierId) activeSupplierId=suppliers[0].id;
    renderAll();
  }

  async function boot(){
    supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
    const {data:{session}}=await supabase.auth.getSession();
    if(session?.user){ currentUser=session.user; $('#app').classList.remove('hidden'); await refresh(); }
  }

  document.addEventListener('DOMContentLoaded',boot);
})();
</script>
</html>
