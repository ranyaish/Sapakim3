<!doctype html>
<html lang="he" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ניהול ספקים — v1-stable</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- לוכדי שגיאות גלובליים -->
<script>
window.addEventListener('error', e=>{
  const el = document.getElementById('authMsg');
  if (el) { el.textContent = 'שגיאת סקריפט: ' + (e.message || e.error); el.className = 'err'; }
  console.error('window.onerror:', e);
});
window.addEventListener('unhandledrejection', e=>{
  const el = document.getElementById('authMsg');
  if (el) { el.textContent = 'שגיאה: ' + (e.reason?.message || e.reason); el.className = 'err'; }
  console.error('unhandledrejection:', e);
});
</script>

<style>
  :root { --bg:#f6f8fb; --card:#fff; --border:#e5e7eb; --ink:#0f172a; --muted:#64748b; --accent:#111827; }
  * { box-sizing:border-box }
  body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial }
  header { position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--border);
           padding:12px 16px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
  h1 { margin:0; font-size:20px; font-weight:800 }
  .muted { color:var(--muted) }
  .btn { border:1px solid var(--border); background:#fff; border-radius:12px; padding:10px 14px; cursor:pointer }
  .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.small { padding:6px 10px; font-size:14px }
  input,select { width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff }
  main { padding:16px; display:grid; grid-template-columns:1fr; gap:16px }
  @media(min-width:980px){ main { grid-template-columns:320px 1fr } }
  .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px }
  ul { list-style:none; margin:0; padding:0 }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .grow { flex:1 }
  .supplier-row { display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px solid var(--border);
                  border-radius:12px; padding:10px; background:#fff }
  .supplier-row.active { outline:2px solid #111827; outline-offset:2px; background:#eef2ff }
  .supplier-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right; background:transparent; border:none }
  table { width:100%; border-collapse:separate; border-spacing:0 }
  th,td { text-align:right; padding:10px; border-top:1px solid var(--border) }
  thead th { background:#f3f4f6; border-top:none }
  .hidden { display:none }
  .badge { padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#fff }
  .ok { color:#047857 } .err { color:#b91c1c }

  /* Tabs */
  .tabs { display:flex; gap:8px; border-bottom:1px solid var(--border); padding:0 16px }
  .tab-btn { border:none; background:transparent; padding:12px 10px; cursor:pointer; border-bottom:2px solid transparent; font-weight:600 }
  .tab-btn.active { border-color:var(--accent); color:var(--accent) }

  /* Modal: בחירת ספק */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40; }
  .modal { position:fixed; left:0; right:0; top:10%; margin:auto; max-width:560px; background:#fff;
           border:1px solid var(--border); border-radius:14px; padding:14px; z-index:50; }
  .modal h3 { margin:0 0 10px }
  .modal .list { max-height:50vh; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:8px }
  .btn-close { background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px 10px; }

  /* טבלת חשבוניות – עמודת שולם לימין עם תאריך קטן */
  .paid-cell { display:flex; align-items:center; gap:6px; justify-content:flex-start }
  .paid-cell small { color:var(--muted) }
</style>

<header>
  <div class="row">
    <h1>ניהול ספקים</h1>
    <span class="badge">v1-stable</span>
    <a class="btn small" href="payments.html" style="text-decoration:none">סיכום חודשי לספקים</a>
  </div>
  <div class="row">
    <input id="email" placeholder="אימייל" autocomplete="username">
    <input id="password" placeholder="סיסמה" type="password" autocomplete="current-password">
    <button id="loginBtn" class="btn primary">כניסה</button>
    <button id="logoutBtn" class="btn hidden">יציאה</button>
    <span id="whoami" class="badge hidden"></span>
    <span id="authMsg" class="muted"></span>
  </div>
</header>

<!-- NAV TABS -->
<div class="tabs hidden" id="navTabs">
  <button class="tab-btn active" id="tabSuppliers">ספקים</button>
  <button class="tab-btn" id="tabMonthly">סיכום חודשי</button>
</div>

<main id="app" class="hidden">
  <!-- טאב ספקים -->
  <aside class="card" id="suppliersPane">
    <h3 style="margin:0 0 10px">ספקים</h3>
    <div class="row">
      <input id="supplierName" class="grow" placeholder="שם ספק">
      <button id="addSupplierBtn" class="btn primary">הוסף</button>
    </div>
    <ul id="supplierList" style="margin-top:10px;max-height:60vh;overflow:auto"></ul>
  </aside>

  <section class="card" id="ledgerPane">
    <div id="emptyState" class="muted">לחץ/י "בחר ספק" כדי להתחיל</div>
    <div id="ledger" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3 id="ledgerTitle" style="margin:0 0 4px">כרטסת</h3>
          <div class="muted">הוסף/י חשבונית: תאריך, סכום, הערות (לא חובה)</div>
        </div>
        <div class="row">
          <button id="openSupplierPickerBtn" class="btn">בחר ספק</button>
          <div class="badge">סה״כ לספק: <b id="grandTotal">₪0.00</b></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <input type="date" id="invDate">
        <input type="number" step="any" id="invAmount" placeholder="0">
        <input id="invNotes" class="grow" placeholder="הערות (אופציונלי)">
        <button id="addInvoiceBtn" class="btn primary">הוסף חשבונית</button>
      </div>

      <div style="margin-top:10px;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table>
          <thead>
            <tr>
              <th>תאריך</th><th>סכום</th><th>הערות</th><th>שולם</th><th></th>
            </tr>
          </thead>
          <tbody id="invoiceTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- טאב סיכום חודשי -->
  <section class="card hidden" id="monthlyPane" style="grid-column:1 / -1">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">סיכום חודשי לכל הספקים</h3>
      <div class="row">
        <label class="muted" for="monthPicker">בחר חודש:</label>
        <input type="month" id="monthPicker" style="width:auto">
        <button id="refreshMonthlyBtn" class="btn">רענן</button>
      </div>
    </div>
    <div style="margin-top:10px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table>
        <thead><tr><th>ספק</th><th>סה״כ לחודש</th></tr></thead>
        <tbody id="monthlyTableBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- פופ־אפ בחירת ספק -->
<div id="modalBackdrop" class="modal-backdrop hidden"></div>
<div id="supplierModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h3>בחירת ספק</h3>
    <button id="closeSupplierPickerBtn" class="btn-close">סגור</button>
  </div>
  <div class="row" style="margin:10px 0">
    <input id="supplierName2" class="grow" placeholder="שם ספק חדש">
    <button id="addSupplierBtn2" class="btn primary">הוסף</button>
  </div>
  <div class="list">
    <ul id="supplierListModal" style="list-style:none; margin:0; padding:0"></ul>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const on=(el,ev,fn,opts)=> el&&el.addEventListener(ev,fn,opts||false);
  const fmt=n=> new Intl.NumberFormat('he-IL',{style:'currency',currency:'ILS'}).format(Number(n)||0);

  // === Supabase CONFIG ===
  const SUPABASE_URL = 'https://uzaqpwbejceyuhnmfdmq.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6YXFwd2JlamNleXVobm1mZG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODc3NzMsImV4cCI6MjA3MDg2Mzc3M30.Wcuu97xzFvJCt8x2ubHLwc19-ZsfrRLK9YZHICV3T3A';

  let supabase=null, currentUser=null;
  let suppliers=[], activeSupplierId=null;
  window.__allInvoices = [];

  // === עדכון שולם עם תאריך מקומי ===
  async function setInvoicePaid(inv, checked){
    const now = new Date();
    const todayLocal = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
    const payload = { paid: checked, paid_at: checked ? todayLocal : null };

    inv.paid = checked;
    inv.paid_at = payload.paid_at;
    renderLedger();

    const { error } = await supabase.from('invoices').update(payload).eq('id', inv.id);
    if(error){
      alert('עדכון "שולם" נכשל: ' + error.message);
      inv.paid = !checked;
      inv.paid_at = !checked ? (inv.paid_at || null) : null;
      renderLedger();
    }
  }

  // === המשך הקוד שלך ... ===
  // (פה נשאר כל מה ששלחת: renderLedger, renderSuppliers, refreshAll וכו')
})();
</script>
</html>
