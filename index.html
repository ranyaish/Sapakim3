<!doctype html>
<html lang="he" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ניהול חשבוניות ספקים — PROD v1.4</title>
<style>
  :root{ --bg:#f6f8fb; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --accent:#111827; --radius:14px; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px;font-weight:800} .muted{color:var(--muted)}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;touch-action:manipulation}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)} .btn.small{padding:8px 10px;font-size:14px}
  input,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
  main{padding:16px;display:grid;grid-template-columns:1fr;gap:16px} @media(min-width:1000px){ main{grid-template-columns:300px 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  ul{list-style:none;margin:0;padding:0}
  .supplier-row{display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%;text-align:right;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff}
  .supplier-row.active{outline:2px solid #111827;outline-offset:2px;background:#eef2ff}
  .supplier-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .supplier-list li+li{margin-top:8px}
  table{width:100%;border-collapse:separate;border-spacing:0} th,td{text-align:right;padding:10px 12px;border-top:1px solid var(--border)}
  thead th{background:#f3f4f6;border-top:none} .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .tab{border:1px solid var(--border);padding:10px 14px;border-radius:12px;background:#fff;cursor:pointer;touch-action:manipulation} .tab.active{background:#111827;color:#fff;border-color:#111827}
  .pill{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:14px;display:inline-flex;gap:6px;align-items:center}
  canvas{max-width:100%;height:auto;border:1px solid var(--border);border-radius:12px;background:#fff} .hidden{display:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .grow{flex:1} .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .version{padding:6px 10px;border-radius:999px;background:#111827;color:#fff;font-weight:700}
  .error{color:#b91c1c} .ok{color:#047857}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<header>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1>ניהול חשבוניות ספקים</h1>
    <span class="version">PROD v1.4</span>
    <span class="muted">URL: uzaqpwbejceyuhnmfdmq.supabase.co</span>
  </div>
  <div class="row" id="authBar">
    <input id="email" class="grow" type="email" placeholder="אימייל" autocomplete="username" />
    <input id="password" class="grow" type="password" placeholder="סיסמה" autocomplete="current-password" />
    <button id="loginBtn" class="btn primary">כניסה</button>
    <button id="logoutBtn" class="btn hidden">יציאה</button>
    <span id="whoami" class="badge hidden"></span>
    <span id="authMsg" class="muted"></span>
  </div>
</header>

<main id="app" class="hidden">
  <aside class="card">
    <h2 style="margin:0 0 10px;font-size:18px">ספקים</h2>
    <div class="row">
      <input id="supplierName" class="grow" placeholder="שם ספק" />
      <button id="addSupplierBtn" class="btn primary" type="button">הוסף</button>
    </div>
    <ul id="supplierList" class="supplier-list" style="margin-top:10px;max-height:60vh;overflow:auto;padding-right:4px"></ul>
  </aside>

  <section class="card">
    <div class="tabs">
      <button id="tabLedger" class="tab active" type="button">כרטסת ספק</button>
      <button id="tabSummary" class="tab" type="button">סיכום חודשי (לספק)</button>
      <button id="tabAll" class="tab" type="button">סיכום חודשי (כל הספקים)</button>
      <button id="tabMonthlyBySupplier" class="tab" type="button">סיכום חודשי לפי ספקים</button>
    </div>

    <!-- Ledger -->
    <div id="ledgerView">
      <div id="emptyState" class="muted">בחר/י ספק משמאל כדי להתחיל</div>
      <div id="ledger" class="hidden">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <h2 id="ledgerTitle" style="margin:0 0 4px;font-size:18px;font-weight:700">כרטסת</h2>
            <div class="muted">רשום/רשמי חשבונית: תאריך, סכום, והערות (לא חובה)</div>
          </div>
          <div class="pill"><span class="muted">סה״כ לספק:</span><strong id="grandTotal">₪0.00</strong></div>
        </div>

        <div class="row" style="margin-top:12px;border:1px solid var(--border);padding:10px;border-radius:12px;background:#f6f7fb;flex-wrap:wrap">
          <input type="date" id="invDate">
          <input type="number" step="any" id="invAmount" placeholder="0">
          <input id="invNotes" class="grow" placeholder="הערות (אופציונלי)">
          <button id="addInvoiceBtn" class="btn primary" type="button">הוסף חשבונית</button>
        </div>

        <div style="margin-top:12px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table>
            <thead><tr><th>תאריך</th><th>סכום</th><th>הערות</th><th></th></tr></thead>
            <tbody id="invoiceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Supplier Summary (single supplier) -->
    <div id="summaryView" class="hidden">
      <div id="summaryEmpty" class="muted">בחר/י ספק משמאל כדי לראות סיכום חודשי.</div>
      <div id="summaryBody" class="hidden">
        <div class="row" style="justify-content:space-between">
          <h2 id="summaryTitle" style="margin:0 0 6px;font-size:18px;font-weight:700">סיכום חודשי</h2>
          <div>
            <label>טווח:</label>
            <select id="rangeSelect">
              <option value="12">12 חודשים אחרונים</option>
              <option value="6">6 חודשים אחרונים</option>
              <option value="3">3 חודשים אחרונים</option>
              <option value="0">כל הזמנים</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px"><canvas id="barChart" width="900" height="280"></canvas></div>
        <div style="margin-top:12px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table><thead><tr><th>חודש</th><th>סה״כ</th></tr></thead><tbody id="summaryTableBody"></tbody></table>
        </div>
      </div>
    </div>

    <!-- All suppliers summary (all invoices combined) -->
    <div id="allView" class="hidden">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0 0 6px;font-size:18px;font-weight:700">סיכום חודשי — כל הספקים</h2>
        <div>
          <label>טווח:</label>
          <select id="rangeSelectAll">
            <option value="12">12 חודשים אחרונים</option>
            <option value="6">6 חודשים אחרונים</option>
            <option value="3">3 חודשים אחרונים</option>
            <option value="0">כל הזמנים</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px"><canvas id="barChartAll" width="900" height="280"></canvas></div>
      <div style="margin-top:12px;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table><thead><tr><th>חודש</th><th>סה״כ</th></tr></thead><tbody id="summaryTableBodyAll"></tbody></table>
      </div>
    </div>

    <!-- NEW: Monthly by supplier (list) -->
    <div id="monthlyBySupplierView" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0 0 6px;font-size:18px;font-weight:700">סיכום חודשי לפי ספקים</h2>
        <div class="row">
          <label>חודש:</label>
          <select id="mbsMonth"></select>
          <label>שנה:</label>
          <select id="mbsYear"></select>
          <button id="mbsRefresh" class="btn">רענן</button>
        </div>
      </div>
      <div class="pill" style="margin-top:8px">סה״כ לחודש: <b id="mbsGrand">₪0.00</b></div>
      <div style="margin-top:12px;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table>
          <thead><tr><th>ספק</th><th>סה״כ לחודש</th></tr></thead>
          <tbody id="mbsTable"></tbody>
          <tfoot><tr><td>סה״כ כל הספקים</td><td id="mbsGrandFoot">₪0.00</td></tr></tfoot>
        </table>
      </div>
      <div id="mbsStatus" class="muted" style="margin-top:8px"></div>
    </div>

  </section>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmtMoney = n => new Intl.NumberFormat("he-IL",{style:"currency",currency:"ILS"}).format(Number(n)||0);
  const monthKey = d => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
  const humanMonth = key => { const [y,m]=key.split("-").map(Number); return new Date(y,m-1,1).toLocaleString("he-IL",{month:"long",year:"numeric"}); };
  const escapeHtml = s => String(s||"").replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;","">":"&gt;"}[c]));

  const SUPABASE_URL = "https://uzaqpwbejceyuhnmfdmq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6YXFwd2JlamNleXVobm1mZG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODc3NzMsImV4cCI6MjA3MDg2Mzc3M30.Wcuu97xzFvJCt8x2ubHLwc19-ZsfrRLK9YZHICV3T3A";

  const authMsg = $("#authMsg");
  const appEl = $("#app");
  const emailEl = $("#email");
  const passEl  = $("#password");
  const loginBtn = $("#loginBtn");
  const logoutBtn = $("#logoutBtn");
  const whoami = $("#whoami");

  let supabase = null, currentUser = null;

  async function createClientWithFallback(){
    if (window.supabase && window.supabase.createClient) {
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });
    }
    try {
      const mod = await import('https://esm.sh/@supabase/supabase-js@2');
      return mod.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });
    } catch(e) {
      authMsg.innerHTML = '<span class="error">שגיאה: ספריית Supabase לא נטענה</span>';
      console.error(e); return null;
    }
  }

  function setAuthUI(loggedIn, email){
    if(loggedIn){
      appEl.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      whoami.classList.remove("hidden");
      whoami.textContent = email || "";
      emailEl.classList.add("hidden"); passEl.classList.add("hidden"); loginBtn.classList.add("hidden");
      authMsg.textContent = "מחובר";
      authMsg.className="ok";
    } else {
      appEl.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      whoami.classList.add("hidden");
      whoami.textContent="";
      emailEl.classList.remove("hidden"); passEl.classList.remove("hidden"); loginBtn.classList.remove("hidden");
      authMsg.textContent = "";
      authMsg.className="";
    }
  }

  async function refreshSession(){
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user || null;
    setAuthUI(!!currentUser, currentUser?.email);
    if(currentUser) await refreshAll();
  }

  loginBtn.addEventListener('click', async ()=>{
    authMsg.textContent = "מתחבר...";
    const { error } = await supabase.auth.signInWithPassword({ email: (emailEl.value||'').trim(), password: passEl.value||'' });
    if(error){ authMsg.innerHTML = '<span class="error">שגיאה: '+escapeHtml(error.message)+'</span>'; }
    else { authMsg.innerHTML = '<span class="ok">מחובר</span>'; }
    await refreshSession();
  });
  logoutBtn.addEventListener('click', async ()=>{ await supabase.auth.signOut(); currentUser=null; setAuthUI(false); });

  // ===== App state =====
  let suppliers=[], invoices=[], activeSupplierId=null;

  const supplierName=$("#supplierName"), supplierList=$("#supplierList");
  const emptyState=$("#emptyState"), ledger=$("#ledger"), ledgerTitle=$("#ledgerTitle");
  const grandTotalEl=$("#grandTotal"), invDate=$("#invDate"), invAmount=$("#invAmount"), invNotes=$("#invNotes");
  const invoiceTableBody=$("#invoiceTableBody");
  const tabLedger=$("#tabLedger"), tabSummary=$("#tabSummary"), tabAll=$("#tabAll"), tabMonthlyBySupplier=$("#tabMonthlyBySupplier");
  const ledgerView=$("#ledgerView"), summaryView=$("#summaryView"), allView=$("#allView"), monthlyBySupplierView=$("#monthlyBySupplierView");
  const summaryEmpty=$("#summaryEmpty"), summaryBody=$("#summaryBody"), summaryTitle=$("#summaryTitle"), rangeSelect=$("#rangeSelect"), summaryTableBody=$("#summaryTableBody"), barChart=$("#barChart");
  const rangeSelectAll=$("#rangeSelectAll"), summaryTableBodyAll=$("#summaryTableBodyAll"), barChartAll=$("#barChartAll");

  // NEW: Monthly-by-supplier controls
  const mbsMonth=$("#mbsMonth"), mbsYear=$("#mbsYear"), mbsRefresh=$("#mbsRefresh"), mbsTable=$("#mbsTable"), mbsGrand=$("#mbsGrand"), mbsGrandFoot=$("#mbsGrandFoot"), mbsStatus=$("#mbsStatus");

  function setActiveTab(activeBtn, showViews, hideViews){
    [tabLedger, tabSummary, tabAll, tabMonthlyBySupplier].forEach(b=>b.classList.remove("active"));
    activeBtn.classList.add("active");
    showViews.forEach(v=>v.classList.remove("hidden"));
    hideViews.forEach(v=>v.classList.add("hidden"));
  }
  tabLedger.onclick=()=> setActiveTab(tabLedger, [ledgerView], [summaryView, allView, monthlyBySupplierView]);
  tabSummary.onclick=()=>{ setActiveTab(tabSummary, [summaryView], [ledgerView, allView, monthlyBySupplierView]); renderSummary(); };
  tabAll.onclick=()=>{ setActiveTab(tabAll, [allView], [ledgerView, summaryView, monthlyBySupplierView]); renderAllSuppliersSummary(); };
  tabMonthlyBySupplier.onclick=()=>{ setActiveTab(tabMonthlyBySupplier, [monthlyBySupplierView], [ledgerView, summaryView, allView]); initMbsIfNeeded(); renderMonthlyBySupplier(); };

  // ===== DB =====
  async function loadSuppliers(){
    const { data, error } = await supabase.from("suppliers").select("*").order("created_at", { ascending: false });
    if(error){ authMsg.innerHTML='<span class="error">'+escapeHtml(error.message)+'</span>'; return []; }
    return data;
  }
  async function loadInvoices(){
    const { data, error } = await supabase.from("invoices").select("*").order("date", { ascending: false });
    if(error){ authMsg.innerHTML='<span class="error">'+escapeHtml(error.message)+'</span>'; return []; }
    return data;
  }
  async function addSupplier(name){
    const { error } = await supabase.from("suppliers").insert({ name });
    if(error) authMsg.innerHTML='<span class="error">שגיאה בהוספת ספק: '+escapeHtml(error.message)+'</span>';
  }
  async function deleteSupplier(id){
    const { error } = await supabase.from("suppliers").delete().eq("id", id);
    if(error) authMsg.innerHTML='<span class="error">שגיאה במחיקת ספק: '+escapeHtml(error.message)+'</span>';
  }
  async function addInvoice(supplier_id, date, amount, notes){
    const { error } = await supabase.from("invoices").insert({ supplier_id, date, amount, notes });
    if(error) authMsg.innerHTML='<span class="error">שגיאה בהוספת חשבונית: '+escapeHtml(error.message)+'</span>';
  }
  async function deleteInvoice(id){
    const { error } = await supabase.from("invoices").delete().eq("id", id);
    if(error) authMsg.innerHTML='<span class="error">שגיאה במחיקת חשבונית: '+escapeHtml(error.message)+'</span>';
  }

  // ===== Render suppliers list (no template literals) =====
  function renderSuppliers(){
    supplierList.innerHTML="";
    if(suppliers.length===0){
      const li=document.createElement("li"); li.className="muted"; li.textContent="עדיין אין ספקים. הוסף/י אחד למעלה."; supplierList.appendChild(li);
      activeSupplierId=null; renderLedger(); return;
    }
    suppliers.forEach((s)=>{
      const li=document.createElement("li");
      const row=document.createElement("div"); row.className="supplier-row"+(activeSupplierId===s.id?" active":"");
      const nameBtn=document.createElement("button"); nameBtn.type="button"; nameBtn.className="supplier-name btn"; nameBtn.style.border="none"; nameBtn.style.background="transparent"; nameBtn.style.textAlign="right"; nameBtn.textContent=s.name;
      const delBtn=document.createElement("button"); delBtn.type="button"; delBtn.className="btn small"; delBtn.textContent="מחק";

      nameBtn.addEventListener("click",()=>{ activeSupplierId=s.id; renderAllViews(); });
      nameBtn.addEventListener("touchstart",(e)=>{ e.preventDefault(); activeSupplierId=s.id; renderAllViews(); });
      delBtn.addEventListener("click", async (e)=>{ e.stopPropagation(); if(!confirm('למחוק את הספק "'+s.name+'" וכל החשבוניות שלו?')) return; await deleteSupplier(s.id); await refreshAll(); });
      delBtn.addEventListener("touchstart", async (e)=>{ e.preventDefault(); e.stopPropagation(); if(!confirm('למחוק את הספק "'+s.name+'" וכל החשבוניות שלו?')) return; await deleteSupplier(s.id); await refreshAll(); });

      row.appendChild(nameBtn); row.appendChild(delBtn);
      li.appendChild(row); supplierList.appendChild(li);
    });
  }

  function renderLedger(){
    if(!activeSupplierId){ emptyState.classList.remove("hidden"); ledger.classList.add("hidden"); return; }
    emptyState.classList.add("hidden"); ledger.classList.remove("hidden");
    const s = suppliers.find(x=>x.id===activeSupplierId);
    document.getElementById("ledgerTitle").textContent = "כרטסת: " + (s && s.name ? s.name : "");
    const inv = invoices.filter(i=>i.supplier_id===activeSupplierId).slice().sort((a,b)=> new Date(b.date)-new Date(a.date));
    const total = inv.reduce((sum,i)=> sum + (Number(i.amount)||0), 0);
    document.getElementById("grandTotal").textContent = fmtMoney(total);
    invoiceTableBody.innerHTML="";
    if(inv.length===0){
      const tr=document.createElement("tr"); const td=document.createElement("td");
      td.colSpan=4; td.className="muted"; td.style.textAlign="center"; td.style.padding="16px"; td.textContent="אין רשומות לתצוגה";
      tr.appendChild(td); invoiceTableBody.appendChild(tr);
    } else {
      inv.forEach((i)=>{
        const tr=document.createElement("tr");
        const td1=document.createElement("td"); td1.textContent = fmtDate(i.date);
        const td2=document.createElement("td"); td2.textContent = fmtMoney(i.amount);
        const td3=document.createElement("td"); td3.textContent = i.notes||"";
        const td4=document.createElement("td"); const del=document.createElement("button"); del.className="btn small"; del.textContent="מחק";
        del.addEventListener("click", async (e)=>{ e.stopPropagation(); await deleteInvoice(i.id); await refreshAll(); });
        del.addEventListener("touchstart", async (e)=>{ e.preventDefault(); e.stopPropagation(); await deleteInvoice(i.id); await refreshAll(); });
        td4.appendChild(del);
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
        invoiceTableBody.appendChild(tr);
      });
    }
  }

  function groupByMonth(relevantInvoices){
    const map=new Map();
    for(const i of relevantInvoices){
      const k = monthKey(new Date(i.date));
      const v = Number(i.amount)||0;
      if(!k || !isFinite(v)) continue;
      map.set(k, (map.get(k)||0) + v);
    }
    return Array.from(map.entries()).sort();
  }
  function getLastNMonthsData(grouped, n){
    if(!n || n<=0) return grouped;
    const today=new Date();
    const seq=[];
    for(let i=n-1;i>=0;i--){
      const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
      const k = monthKey(d);
      const found = grouped.find(([mk])=> mk===k);
      seq.push([k, found? found[1]: 0]);
    }
    return seq;
  }
  function drawBarChart(rows, canvas){
    const ctx=canvas.getContext("2d"); const W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    const padL=60, padR=20, padT=20, padB=40;
    const chartW=W-padL-padR, chartH=H-padT-padB;
    const values=rows.map(r=>r[1]); const maxVal=Math.max(10, ...values, 1); const y0=padT+chartH;
    ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,y0); ctx.lineTo(padL+chartW,y0); ctx.stroke();
    ctx.fillStyle="#64748b"; ctx.font="12px system-ui";
    [0,0.5,1].forEach(fr=>{ const val=Math.round(maxVal*fr), y=y0-chartH*fr; ctx.fillText(fmtMoney(val).replace("\u00A0"," "), 6, y+4); ctx.strokeStyle="#f1f5f9"; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+chartW,y); ctx.stroke(); });
    const gap=10; const count=rows.length||1; const barW=Math.max(6, Math.floor((chartW-gap*(count-1))/count));
    let x=padL; rows.forEach(([k,sum])=>{ const h=Math.round((sum/maxVal)*chartH); const y=y0-h; ctx.fillStyle="#111827"; ctx.fillRect(x,y,barW,h); ctx.fillStyle="#64748b"; const label=humanMonth(k); ctx.save(); ctx.translate(x+barW/2, y0+14); ctx.rotate(-Math.PI/8); const tw=ctx.measureText(label).width; ctx.fillText(label, -Math.min(100,tw)/2, 0); ctx.restore(); x+=barW+gap; });
  }

  function renderSummary(){
    if(!activeSupplierId){ summaryEmpty.classList.remove("hidden"); summaryBody.classList.add("hidden"); return; }
    summaryEmpty.classList.add("hidden"); summaryBody.classList.remove("hidden");
    const s = suppliers.find(x=>x.id===activeSupplierId);
    document.getElementById("summaryTitle").textContent = "סיכום חודשי: " + (s && s.name ? s.name : "");
    const inv = invoices.filter(i=>i.supplier_id===activeSupplierId);
    const grouped = groupByMonth(inv); const n = parseInt(rangeSelect.value,10);
    const rows = getLastNMonthsData(grouped, n);
    renderSummaryTableAndChart(rows, summaryTableBody, barChart);
  }

  function renderAllSuppliersSummary(){
    const grouped = groupByMonth(invoices); const n = parseInt(rangeSelectAll.value,10);
    const rows = getLastNMonthsData(grouped, n);
    renderSummaryTableAndChart(rows, summaryTableBodyAll, barChartAll);
  }

  function renderSummaryTableAndChart(rows, tbody, canvas){
    tbody.innerHTML=""; if(rows.length===0){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=2; td.className="muted"; td.style.textAlign="center"; td.style.padding="16px"; td.textContent="אין נתונים להצגה"; tr.appendChild(td); tbody.appendChild(tr); }
    else { rows.forEach(([k,sum])=>{ const tr=document.createElement("tr"); const td1=document.createElement("td"); td1.textContent=humanMonth(k); const td2=document.createElement("td"); td2.textContent=fmtMoney(sum); tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr); }); }
    drawBarChart(rows, canvas);
  }

  // ===== NEW: Monthly by supplier (list) =====
  function initMbsIfNeeded(){
    if(mbsMonth.options.length>0) return;
    const months = ["ינואר","פברואר","מרץ","אפריל","מאי","יוני","יולי","אוגוסט","ספטמבר","אוקטובר","נובמבר","דצמבר"];
    months.forEach((m,i)=>{ const opt=document.createElement("option"); opt.value=String(i+1); opt.textContent=m; mbsMonth.appendChild(opt); });
    const now=new Date(); const thisY=now.getFullYear();
    for(let y=thisY-5;y<=thisY+1;y++){ const opt=document.createElement("option"); opt.value=String(y); opt.textContent=String(y); mbsYear.appendChild(opt); }
    mbsMonth.value=String(new Date().getMonth()+1); mbsYear.value=String(thisY);
    mbsRefresh.addEventListener("click", renderMonthlyBySupplier);
    mbsMonth.addEventListener("change", renderMonthlyBySupplier);
    mbsYear.addEventListener("change", renderMonthlyBySupplier);
  }

  function renderMonthlyBySupplier(){
    // filter invoices by selected month
    const y = Number(mbsYear.value), m = Number(mbsMonth.value);
    const start = new Date(y, m-1, 1); const end = new Date(y, m, 1);
    const filtered = invoices.filter(inv=>{ const d=new Date(inv.date); return d>=start && d<end; });
    // aggregate per supplier
    const totalsById = new Map();
    for(const inv of filtered){
      const key = inv.supplier_id; const amt = Number(inv.amount)||0;
      totalsById.set(key, (totalsById.get(key)||0)+amt);
    }
    const rows = suppliers.map(s=>({ name: s.name, total: totalsById.get(s.id)||0 })).sort((a,b)=> b.total - a.total);

    // render table
    mbsTable.innerHTML=""; let grand=0;
    rows.forEach(r=>{ grand+=r.total; const tr=document.createElement("tr"); const td1=document.createElement("td"); td1.textContent=r.name; const td2=document.createElement("td"); td2.textContent=fmtMoney(r.total); tr.appendChild(td1); tr.appendChild(td2); mbsTable.appendChild(tr); });
    mbsGrand.textContent = fmtMoney(grand);
    mbsGrandFoot.textContent = fmtMoney(grand);
    const ym = new Date(y, m-1, 1).toLocaleString("he-IL",{month:"long",year:"numeric"});
    mbsStatus.innerHTML = 'מוצג חודש: <b>'+ym+'</b>. ספקים: '+suppliers.length+' | חשבוניות בחודש: '+filtered.length;
  }

  // Events
  document.getElementById("addSupplierBtn").addEventListener("click", async ()=>{ const name = supplierName.value.trim(); if(!name) return alert("נא להזין שם ספק"); if(suppliers.some(x=>x.name===name)) return alert("ספק כבר קיים"); await addSupplier(name); supplierName.value=""; await refreshAll(); });
  document.getElementById("addInvoiceBtn").addEventListener("click", async ()=>{ if(!activeSupplierId) return alert("בחר/י ספק קודם"); const date = invDate.value; const amount = parseFloat(invAmount.value); const notes = invNotes.value || ""; if(!date || isNaN(amount)) return alert("נא להזין תאריך וסכום"); await addInvoice(activeSupplierId, date, amount, notes); invDate.value=""; invAmount.value=""; invNotes.value=""; await refreshAll(); });

  function fmtDate(iso){ const d=new Date(iso); return isNaN(d.getTime()) ? iso : d.toLocaleDateString("he-IL"); }

  async function refreshAll(){
    suppliers = await loadSuppliers(); invoices  = await loadInvoices();
    if(suppliers.length && !activeSupplierId) activeSupplierId = suppliers[0].id;
    renderAllViews();
  }
  function renderAllViews(){
    renderSuppliers(); renderLedger();
    if(!summaryView.classList.contains("hidden")) renderSummary();
    if(!allView.classList.contains("hidden")) renderAllSuppliersSummary();
    if(!monthlyBySupplierView.classList.contains("hidden")) renderMonthlyBySupplier();
  }

  // Boot
  (async ()=>{
    supabase = await createClientWithFallback(); if(!supabase) return;
    const { data: { session } } = await supabase.auth.getSession();
    currentUser = session?.user || null; setAuthUI(!!currentUser, currentUser?.email);
    if(currentUser) await refreshAll();
  })();
})();
</script>
</html>
